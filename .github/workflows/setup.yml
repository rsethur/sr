name: setup
on: 
  workflow_dispatch

jobs:  
  setup:
    name: setup
    runs-on: ubuntu-latest
    steps:
    - name: azure login
      uses: azure/login@v1
      with:
        creds: ${{secrets.AZURE_CREDENTIALS}}
    - run: |
          az config set defaults.workspace=${{secrets.AML_WORKSPACE}}
          az config set defaults.group=${{secrets.RESOURCE_GROUP}}          
          az account set -s ${{secrets.SUBSCRIPTION_ID}}  
    - name: Install azureml cli extension
      run: az extension add --source https://azuremlsdktestpypi.blob.core.windows.net/wheels/sdk-cli-v2/ml-0.0.15_october_cand-py3-none-any.whl --yes
      #run: az extension add -n ml -y
    - name: create azureml workspace if it does not exist
    - run: az ml workspace create -n ${{secrets.AML_WORKSPACE}} --location ${{secrets.LOCATION}}
    - name: Checkout
      uses: actions/checkout@v2.3.3
    - name: Setup Python
      uses: actions/setup-python@v2.1.4
      with:
        python-version: 3.7    
    - name: "Create Log Analytics workspace (if it does not exist)"
      run: az monitor log-analytics workspace create --workspace-name ${{secrets.LA_WORKSPACE}}  --retention-time 730 --location ${{secrets.LA_LOCATION}} --sku pergb2018 
    - name: Create dataset
      run: az ml dataset create -n credit-dataset -v 1 --datastore-name workspaceblobstore -l dataset/german_credit_data.csv
    - name: create training cluster
      run: az ml compute create -n cpu-cluster --type amlcompute --min-instances 0 --max-instances 5
